<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>NeoNimbus Pro+ · 天气卡片</title>
  <meta name="color-scheme" content="dark only">
  <style>
    /* ==========================================
       NeoNimbus Pro+ · 专业版升级
       方向：暗色高端 + 新拟态/玻璃 + 极光 + 3D/移动友好
       加强项：
       - 动态特效全面升级：雨溅、闪电、雪雾、风涡旋
       - 风模式切换框错位修复（分段背景对齐 gap）
       - 移动端适配：降噪/降粒子/禁 3D 倾斜，窄屏排版优化
       ========================================== */

    :root{
      --bg-0:#07090F;
      --bg-1:#0B101B;
      --bg-2:#0E1526;
      --ink:#E8EEF8;
      --muted:#A6B2C7;
      --line:rgba(255,255,255,0.12);
      --glass:rgba(255,255,255,0.08);
      --frost:rgba(255,255,255,0.06);

      --neu-sh-1:-14px -14px 28px rgba(255,255,255,0.02);
      --neu-sh-2:18px 18px 48px rgba(0,0,0,0.55);
      --neu-press:inset 8px 8px 16px rgba(0,0,0,0.5),
                   inset -8px -8px 16px rgba(255,255,255,0.04);

      --radius:26px;
      --radius-sm:14px;

      /* 主题可被天气覆盖 */
      --accent:#86B8FF;
      --accent-2:#9CFFE8;
      --sky-a:#0B1020;
      --sky-b:#0F1A32;
      --fx-1:#86C3FF;
      --fx-2:#B4F5FF;

      /* 交互参数 */
      --toggle-gap:8px; /* 修复风模式下分段背景对齐 */
    }

    /* 天气主题覆盖（低饱和严控） */
    body.theme--sunny{
      --accent:#FFD36E; --accent-2:#FFAE6E;
      --sky-a:#0A0E1F; --sky-b:#1A2B58;
      --fx-1:#FFD36E;  --fx-2:#FFE27A;
    }
    body.theme--rainy{
      --accent:#79B8FF; --accent-2:#8CC6FF;
      --sky-a:#090F1C; --sky-b:#0E1A2E;
      --fx-1:#6EC1FF;  --fx-2:#9EC8FF;
    }
    body.theme--snowy{
      --accent:#DFF2FF; --accent-2:#B9E7FF;
      --sky-a:#0A1224; --sky-b:#1B2D4C;
      --fx-1:#EAF7FF;  --fx-2:#CFE9FF;
    }
    body.theme--windy{
      --accent:#9DF0DE; --accent-2:#79DFFF;
      --sky-a:#071425; --sky-b:#0E2550;
      --fx-1:#97FFEE;  --fx-2:#72D2FF;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", "Hiragino Sans GB", "Noto Sans CJK SC", sans-serif;
      background:
        radial-gradient(1200px 800px at 70% -12%, rgba(140,170,255,.12), transparent 60%) no-repeat,
        linear-gradient(160deg, var(--sky-a), var(--sky-b));
      overflow:hidden;
    }

    /* 柔噪纹理（高级材质感） */
    .noise{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140">\
        <filter id="n"><feTurbulence baseFrequency="0.65" numOctaves="1" seed="3"/><feColorMatrix type="saturate" values="0"/></filter>\
        <rect width="100%" height="100%" filter="url(%23n)" opacity="0.035"/>\
      </svg>');
      background-size:140px 140px; mix-blend-mode:soft-light;
    }

    /* 极光层（更细腻） */
    .aurora{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      filter: blur(30px) saturate(115%);
      opacity:.62; mix-blend-mode:screen;
      background:
        conic-gradient(from 220deg at 80% 28%, color-mix(in srgb, var(--accent) 30%, transparent), transparent 48% 66%, color-mix(in srgb, var(--accent-2) 22%, transparent)),
        radial-gradient(560px 260px at 18% 14%, color-mix(in srgb, var(--accent-2) 24%, transparent), transparent 60%),
        radial-gradient(440px 240px at 76% 86%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 70%);
      animation: auroraShift 16s ease-in-out infinite alternate;
    }
    @keyframes auroraShift{
      0%{ transform:translateY(0) translateX(0) scale(1); opacity:.55;}
      100%{ transform:translateY(-2%) translateX(1%) scale(1.018); opacity:.75;}
    }

    .wrap{
      position:relative; z-index:1; width:100%; height:100%;
      display:grid; place-items:center; padding:28px;
      perspective: 1400px; /* 3D 视角 */
    }

    /* 玻璃新拟态卡片 + 3D 交互 */
    .card{
      position:relative;
      width: clamp(360px, 90vw, 680px);
      min-height: 380px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.018));
      box-shadow: var(--neu-sh-1), var(--neu-sh-2);
      backdrop-filter: blur(18px) saturate(120%); -webkit-backdrop-filter: blur(18px) saturate(120%);
      transform-style: preserve-3d;
      transition: transform 280ms cubic-bezier(.2,.8,.2,1), box-shadow 280ms ease;
      overflow:hidden; isolation:isolate;
    }
    .card::before{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none; padding:1px;
      background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.08));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude;
    }
    .card::after{
      content:""; position:absolute; inset:-2px; border-radius:inherit; pointer-events:none;
      background: radial-gradient(560px 380px at var(--mx,65%) var(--my,36%), color-mix(in srgb, var(--accent) 22%, transparent) 0%, transparent 62%);
      opacity:.46; transition: background .35s ease;
      transform: translateZ(40px);
    }

    .scene{ position:absolute; inset:0; border-radius:inherit; overflow:hidden; z-index:0; transform-style:preserve-3d; }

    /* 前景散景（bokeh） */
    .bokeh{
      position:absolute; inset:-10% -10% -10% -10%; pointer-events:none; z-index:1;
      filter: blur(2px);
    }
    .bokeh .dot{
      position:absolute; width:10px; height:10px; border-radius:50%;
      background: radial-gradient(circle, color-mix(in srgb, var(--fx-2) 70%, transparent), transparent 60%);
      opacity:.0;
      animation: bokehDrift linear infinite;
    }
    @keyframes bokehDrift{
      0%{ transform: translateY(0) translateX(0) scale(1); opacity:.0;}
      10%{ opacity:.35;}
      80%{ opacity:.35;}
      100%{ transform: translateY(220px) translateX(60px) scale(1.2); opacity:.0;}
    }

    .header{
      position:relative; z-index:2; display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px 8px 18px; transform: translateZ(60px);
    }
    .loc{ display:flex; align-items:center; gap:10px; font-weight:650; letter-spacing:.2px; text-shadow:0 1px 0 rgba(0,0,0,.35); }
    .badge{ font-size:11px; color:var(--muted); padding:4px 8px; border-radius:999px; background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05)); border:1px solid var(--line); }

    /* 分段切换（对齐 gap 修复） */
    .toggle{
      position:relative; display:grid; grid-template-columns:repeat(4,1fr); gap:var(--toggle-gap);
      border-radius:var(--radius-sm); padding:8px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--neu-press); transform: translateZ(60px);
    }
    .toggle .seg-bg{
      position:absolute; top:8px; bottom:8px; left:8px; width: calc(25% - 0px); border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.26), rgba(255,255,255,.1));
      border:1px solid rgba(255,255,255,.32);
      box-shadow: 0 6px 22px rgba(0,0,0,.28), 0 0 0 1px rgba(255,255,255,.06) inset;
      /* 定位与尺寸由 JS 设置 left/width，避免 transform 偏移误差 */
      transition: left 360ms cubic-bezier(.16,.84,.26,1.15), width 260ms ease, background .25s ease;
      will-change: left, width;
    }
    .toggle button{
      appearance:none; border:0; background:transparent; color:var(--muted);
      border-radius:10px; padding:10px 10px; font-size:13px; letter-spacing:.2px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      cursor:pointer; transition: color .25s ease, transform .06s ease, filter .25s ease;
    }
    .toggle button:hover{ filter: drop-shadow(0 4px 16px color-mix(in srgb, var(--accent) 18%, transparent)); }
    .toggle button:active{ transform: translateY(1px) scale(.98); }
    .toggle button.active{ color:var(--ink); text-shadow:0 0 16px color-mix(in srgb, var(--accent) 18%, transparent); }

    /* 强度分段（三级） */
    .intensity{
      position:relative; display:grid; grid-template-columns:repeat(3,1fr); gap:6px;
      border-radius:12px; padding:6px; margin: 6px 0 0 0;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--neu-press);
      transform: translateZ(60px);
    }
    .intensity .seg-bg{
      position:absolute; top:6px; bottom:6px; left:6px; width: calc(33.333% - 0px); border-radius:8px;
      background: linear-gradient(180deg, rgba(255,255,255,.26), rgba(255,255,255,.1));
      border:1px solid rgba(255,255,255,.32);
      box-shadow: 0 4px 16px rgba(0,0,0,.22), 0 0 0 1px rgba(255,255,255,.06) inset;
      transition: left 320ms cubic-bezier(.16,.84,.26,1.15), width 220ms ease;
      will-change: left, width;
    }
    .intensity button{
      appearance:none; border:0; background:transparent; color:var(--muted);
      border-radius:8px; padding:8px 8px; font-size:12px; letter-spacing:.2px;
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer; transition: color .25s ease, transform .06s ease, filter .25s ease;
    }
    .intensity button.active{ color:var(--ink); }

    .body{
      position:relative; z-index:1; display:grid; grid-template-columns: 1.2fr 1fr; gap:12px; padding:8px 16px 10px 16px;
      transform: translateZ(40px);
    }
    .left{ padding:8px 10px 10px 16px; }
    .right{ display:grid; align-content:center; gap:14px; padding:8px 16px 10px 10px; }

    .temp{ font-size: clamp(44px, 8.6vw, 68px); line-height:1; font-weight:800; letter-spacing:-1px; color:#F7FBFF; text-shadow:0 10px 28px rgba(0,0,0,.55); }
    .cond{ margin-top:10px; color:var(--muted); font-size:14px; }

    .meta{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .chip{ border-radius:12px; padding:10px; font-size:12px; color:var(--muted); background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05)); border:1px solid var(--line); display:grid; gap:6px; }
    .chip strong{ font-size:16px; color:var(--ink); text-shadow:0 1px 0 rgba(0,0,0,.35); }

    /* AQI 贴片（色阶） */
    .aqi{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .aqi .tag{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); }
    .aqi.good .tag{ background:linear-gradient(180deg, rgba(120,255,180,.18), rgba(120,255,180,.06)); color:#bdfcd3; }
    .aqi.moderate .tag{ background:linear-gradient(180deg, rgba(255,220,120,.18), rgba(255,220,120,.06)); color:#ffe6a3; }

    /* 小时趋势：火花线容器 */
    .trend{
      margin-top:6px; padding:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid var(--line);
    }
    .trend-title{ font-size:12px; color:var(--muted); margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; }
    .trend canvas{ width:100%; height:64px; display:block; filter: drop-shadow(0 4px 12px color-mix(in srgb, var(--accent) 20%, transparent)); }

    .footer{
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 6px 16px 16px 16px; color:var(--muted); font-size:12px;
      transform: translateZ(50px);
    }
    .bar{ flex:1; height:4px; border-radius:999px; background:linear-gradient(90deg, color-mix(in srgb, var(--accent) 28%, transparent), transparent); box-shadow: 0 0 18px color-mix(in srgb, var(--accent) 36%, transparent); }

    /* 场景元素：太阳/云/雨/雪/风 */
    /* 太阳：更自然的光学层次与柔和色温 */
    .sun{
      position:absolute; width:132px; height:132px; top:-34px; right:-34px; opacity:0; transform:scale(.9) translateZ(30px);
      border-radius:50%;
      background:
        radial-gradient(circle at 42% 42%, #fff9da 0%, #ffe49a 38%, #ffc66a 58%, rgba(255,183,77,0) 72%);
      filter: saturate(105%) contrast(105%);
      animation: sunPulse 8s ease-in-out infinite;
    }
    .sun::before{
      content:""; position:absolute; inset:-22px; border-radius:50%;
      background: radial-gradient(closest-side, rgba(255,236,170,.28), rgba(255,236,170,0));
      filter: blur(10px); opacity:.85;
    }
    .sun::after{
      content:""; position:absolute; inset:-56px; border-radius:50%;
      background:
        conic-gradient(from 0deg, rgba(255,227,122,.20), transparent 45% 55%, rgba(255,227,122,.20)),
        radial-gradient(closest-side, rgba(255,227,122,.14), transparent 78%);
      filter: blur(7px); animation: rays 18s linear infinite;
    }
    @keyframes sunPulse{ 0%{transform:scale(.92) translateZ(30px); opacity:.92;} 50%{transform:scale(1) translateZ(30px); opacity:1;} 100%{transform:scale(.92) translateZ(30px); opacity:.92;} }
    @keyframes rays{ to{ transform: rotate(360deg);} }

    /* 高强度晴天强调态：更亮、更热的太阳与外发光 */
    .sun.hot{
      filter: saturate(125%) contrast(118%) drop-shadow(0 0 20px rgba(255,210,120,.55)) drop-shadow(0 0 36px rgba(255,210,120,.35));
    }
    .sun.hot::before{
      opacity:.95; filter: blur(9px);
    }
    .sun.hot::after{
      filter: blur(8px);
    }

    .cloud{
      position:absolute; background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.78));
      border-radius:40px; box-shadow:0 6px 16px rgba(0,0,0,.22);
      opacity:0; transform: translateX(-20%); filter: blur(.25px);
    }
    .cloud::before, .cloud::after{ content:""; position:absolute; background:inherit; border-radius:40px; }
    .cloud::before{ width:60%; height:80%; left:-20%; top:-28%; }
    .cloud::after{ width:48%; height:70%; right:-14%; top:-10%; }

    .raindrop{
      position:absolute;
      width:2px;
      height:18px;
      opacity:.82;
      background:linear-gradient(180deg, rgba(174,213,255,.92), rgba(174,213,255,.08));
      border-radius:2px;
      filter: blur(.2px);
      transform: translateY(-30px) translateX(0) rotate(var(--angle, 11deg));
      animation: rainFall linear infinite;
      /* 轻微拖影提升速度感 */
      box-shadow: 0 4px 6px rgba(110, 180, 255, 0.25);
    }
    /* 高光点（折射） */
    .raindrop::after{
      content:"";
      position:absolute;
      top:0; left:-1px;
      width:4px; height:4px; border-radius:50%;
      background: radial-gradient(circle, rgba(255,255,255,.9), rgba(255,255,255,0));
      opacity:.65; filter: blur(.2px);
    }
    @keyframes rainFall{
      0%{
        transform: translateY(-60px) translateX(0) rotate(var(--angle, 11deg));
        opacity:0;
      }
      10%{ opacity:.9; }
      100%{
        transform: translateY(400px) translateX(var(--drift, 38px)) rotate(var(--angle, 11deg));
        opacity:.22;
      }
    }

    /* 雨溅波纹（新增） */
    .splash{
      position:absolute; width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(158,210,255,.55);
      opacity:.0;
      animation: splashRip 900ms ease-out forwards;
      filter: blur(.3px);
    }
    @keyframes splashRip{
      0%{ transform: scale(.2); opacity:.0; }
      30%{ opacity:.9; }
      100%{ transform: scale(1.8); opacity:.0; }
    }

    /* 闪电（新增） */
    .lightning{
      position:absolute; inset:0; pointer-events:none; background:
        radial-gradient(200px 120px at 70% 0%, rgba(255,255,255,.9), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.0), rgba(255,255,255,.0));
      opacity:0; mix-blend-mode:screen;
      animation: flash 600ms ease-out forwards;
    }

    /* 溅射子滴（冠状飞溅） */
    .splash-dot{
      position:absolute;
      width:3px; height:3px; border-radius:50%;
      background: radial-gradient(circle, rgba(180,220,255,.95), rgba(180,220,255,0));
      pointer-events:none;
      opacity:0;
      filter: blur(.2px);
      animation: splashDot 640ms ease-out forwards;
    }
    @keyframes splashDot{
      0%{ transform: translate(0, 0) scale(.6); opacity:.0; }
      20%{ opacity:.95; }
      100%{ transform: translate(var(--dx, 20px), var(--dy, -40px)) scale(1); opacity:0; }
    }
    @keyframes flash{
      0%{ opacity:0; }
      10%{ opacity:.95; }
      40%{ opacity:.25; }
      100%{ opacity:0; }
    }

    .flake{
      position:absolute; width:8px; height:8px; border-radius:50%;
      background: radial-gradient(circle, #FFFFFF 0%, rgba(255,255,255,.9) 62%, rgba(255,255,255,0) 63%);
      box-shadow: 0 0 10px rgba(255,255,255,.6);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.35));
      animation: snowDrift linear infinite; opacity:.94;
    }
    @keyframes snowDrift{
      0%{ transform: translateY(-40px) translateX(0) rotate(0); opacity:0; }
      10%{ opacity:1; }
      55%{ transform: translateY(200px) translateX(24px) rotate(180deg); }
      100%{ transform: translateY(400px) translateX(48px) rotate(360deg); opacity:.7; }
    }

    /* 冷雾（新增：雪天雾气） */
    .mist{
      position:absolute; left:-20%; right:-20%; bottom:-10px; height:60%;
      background: radial-gradient(60% 40% at 50% 100%, rgba(210,230,255,.12), rgba(210,230,255,0));
      filter: blur(18px); opacity:.0; animation: mistRise 10s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes mistRise{
      0%{ transform: translateY(10px); opacity:.08; }
      100%{ transform: translateY(-8px); opacity:.18; }
    }

    /* 雪地堆积（新增） */
    .snow-pile{
      position:absolute; left:0; right:0; bottom:0; height:0;
      background:
        radial-gradient(60% 30% at 20% 100%, rgba(255,255,255,.85), rgba(255,255,255,0) 70%),
        radial-gradient(60% 30% at 55% 100%, rgba(245,252,255,.85), rgba(245,252,255,0) 70%),
        radial-gradient(60% 30% at 85% 100%, rgba(238,249,255,.8), rgba(238,249,255,0) 70%);
      transition: height 600ms cubic-bezier(.2,.8,.2,1), filter 600ms ease;
      filter: drop-shadow(0 -6px 16px rgba(255,255,255,.06));
      pointer-events:none;
      z-index: 1;
    }
    .snow-pile::after{
      content:""; position:absolute; inset:0 0 0 0;
      background:
        radial-gradient(3px 3px at 10% 30%, rgba(255,255,255,.6), transparent 60%),
        radial-gradient(4px 4px at 30% 20%, rgba(255,255,255,.5), transparent 60%),
        radial-gradient(2px 2px at 70% 25%, rgba(255,255,255,.4), transparent 60%),
        radial-gradient(3px 3px at 90% 35%, rgba(255,255,255,.55), transparent 60%);
      opacity:.4; filter: blur(.6px);
    }

    /* 堆积小帽（零星凸起） */
    .snow-cap{
      position:absolute; bottom:0;
      width: 10px; height: 6px; border-radius: 10px 10px 0 0;
      background: linear-gradient(180deg, #ffffff, #eaf6ff);
      box-shadow: 0 -1px 0 rgba(255,255,255,.6) inset;
      opacity: 0; transform: translateY(4px);
      animation: capRise 1200ms ease forwards;
      pointer-events:none;
      z-index: 2;
    }
    @keyframes capRise{
      to{ opacity:1; transform: translateY(0); }
    }

    /* 落叶堆积（新增） */
    .leaf-pile{
      position:absolute; left:0; right:0; bottom:0; height:0;
      background:
        radial-gradient(60% 30% at 25% 100%, rgba(170,120,60,.38), rgba(170,120,60,0) 70%),
        radial-gradient(60% 30% at 60% 100%, rgba(120,90,50,.38), rgba(120,90,50,0) 70%),
        radial-gradient(60% 30% at 85% 100%, rgba(190,140,70,.34), rgba(190,140,70,0) 70%);
      transition: height 600ms cubic-bezier(.2,.8,.2,1), filter 600ms ease;
      filter: drop-shadow(0 -6px 16px rgba(0,0,0,.12));
      pointer-events:none;
      z-index: 1;
    }
    .leaf-cap{
      position:absolute; bottom:0;
      width: 10px; height: 6px; border-radius: 10px 10px 0 0;
      background: linear-gradient(180deg, #a86d2a, #6b4320);
      box-shadow: 0 -1px 0 rgba(255,255,255,.15) inset;
      opacity: 0; transform: translateY(4px);
      animation: capRise 1200ms ease forwards;
      pointer-events:none;
      z-index: 2;
    }

    /* 切换过渡遮罩（更顺滑） */
    .veil{
      position:absolute; inset:0; pointer-events:none; z-index:2;
      background: radial-gradient(80% 60% at 50% 40%, rgba(255,255,255,.06), rgba(255,255,255,0) 70%);
      opacity:0; transition: opacity 260ms ease;
    }
    .veil.show{ opacity:1; }

    .wind-line{
      position:absolute; height:2px; width:136px; opacity:0;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(180,245,255,.8) 35%, rgba(151,255,238,0) 100%);
      border-radius:2px; filter: blur(.25px); animation: windSweep linear infinite;
    }
    @keyframes windSweep{
      0%{ transform: translateX(-170px); opacity:0; }
      12%{ opacity:.88; }
      90%{ opacity:.88; }
      100%{ transform: translateX(580px); opacity:0; }
    }
    .leaf{
      position:absolute; width:12px; height:8px; opacity:.96;
      background: radial-gradient(ellipse at 50% 50%, #9CFFD3 0%, #42E6C4 60%, #1FBFA6 100%);
      border-radius:50% 50% 50% 50% / 60% 60% 40% 40%;
      transform-origin:50% 50%; filter: drop-shadow(0 2px 4px rgba(0,0,0,.35));
      animation: leafDrift linear infinite;
    }
    @keyframes leafDrift{
      0%{ transform: translate(-40px,-30px) rotate(0); }
      50%{ transform: translate(230px,130px) rotate(220deg); }
      100%{ transform: translate(520px,260px) rotate(480deg); opacity:.66; }
    }

    /* 风涡旋（新增） */
    .swirl{
      position:absolute; width:120px; height:120px; border-radius:50%;
      border-top:2px solid rgba(151,255,238,.35);
      border-right:2px solid rgba(151,255,238,0);
      border-left:2px solid rgba(151,255,238,0);
      border-bottom:2px solid rgba(151,255,238,0);
      filter: blur(.2px);
      opacity:.0;
      animation: swirlSpin 2400ms linear infinite;
    }
    @keyframes swirlSpin{
      0%{ transform: translate(-120px, 0) rotate(0deg) scale(.6); opacity:.0; }
      10%{ opacity:.6; }
      80%{ opacity:.6; }
      100%{ transform: translate(520px, 120px) rotate(360deg) scale(1.1); opacity:.0; }
    }

    /* 状态显隐 */
    .is-sunny .sun{ opacity:1; }
    .is-rainy .raindrop{ opacity:.88; }
    .is-rainy .splash{ opacity:.9; }
    .is-snowy .flake{ opacity:.96; }
    .is-snowy .mist{ opacity:.16; }
    .is-windy .wind-line{ opacity:.86; }
    .is-windy .leaf{ opacity:.95; }

    /* 响应式与动效降级 */
    @media (max-width:640px){
      .body{ grid-template-columns:1fr; }
      .right{ grid-row:1; }
      .left{ grid-row:2; }
      .card{ min-height: 420px; }
      /* 移动端：避免 3D 倾斜导致卡片截断 */
      .wrap{ perspective: 0; }
      .card{ transform: none !important; }
    }
    @media (max-width:420px){
      .header{ padding:14px; }
      .body{ padding:6px 12px 8px 12px; }
      .footer{ padding:6px 12px 12px 12px; }
      .toggle{ padding:6px; }
      .toggle .seg-bg{ top:6px; bottom:6px; left:6px; }
      :root{ --toggle-gap:6px; }
    }
    @media (prefers-reduced-motion:reduce){
      /* 降级而不完全禁用，确保仍可见基础动效（统一放慢并减少眩光） */
      .raindrop, .flake, .wind-line, .leaf, .cloud, .sun { animation-duration: 3000ms !important; }
      .aurora { animation-duration: 24000ms !important; opacity: .5 !important; }
      .swirl, .bokeh .dot { animation-duration: 3200ms !important; }
      .lightning { display: none !important; } /* 眩光去除 */
      .card { transition: none !important; }
    }
  </style>
</head>
<body class="theme--sunny">
  <div class="noise" aria-hidden="true"></div>
  <div class="aurora" aria-hidden="true"></div>

  <div class="wrap">
    <div class="card is-sunny" id="card" aria-live="polite">
      <div class="scene" id="scene">
        <!-- 太阳/云/粒子由脚本注入 -->
        <div class="sun" id="sun" aria-hidden="true"></div>
        <div class="mist" id="mist" aria-hidden="true"></div>
        <div class="bokeh" id="bokeh" aria-hidden="true"></div>
        <div class="snow-pile" id="snowPile" aria-hidden="true"></div>
        <div class="leaf-pile" id="leafPile" aria-hidden="true"></div>
        <div class="veil" id="veil" aria-hidden="true"></div>
      </div>

      <div class="header">
        <div class="loc">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z" fill="currentColor"/>
          </svg>
          <span id="city">河池</span>
          <span class="badge" id="badge">观测中</span>
        </div>

        <div class="toggle" role="tablist" aria-label="切换天气">
          <div class="seg-bg" id="segBg" aria-hidden="true"></div>
          <button class="active" data-mode="sunny" aria-pressed="true" role="tab" aria-selected="true" title="晴天">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true">
              <path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.79 1.8-1.79zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zM4.22 19.78l1.79-1.79-1.79-1.79-1.79 1.79 1.79 1.79zM20.83 4.84l-1.79-1.79-1.8 1.79 1.8 1.79 1.79-1.79zM20 11v2h3v-2h-3zm-8-8h2V0h-2v3zm7.78 16.78l-1.79-1.79-1.79 1.79 1.79 1.79 1.79-1.79zM12 6a6 6 0 100 12A6 6 0 0012 6z"/>
            </svg> 晴
          </button>
          <button data-mode="rainy" aria-pressed="false" role="tab" aria-selected="false" title="雨天">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
              <path d="M6 14a4 4 0 010-8 5.5 5.5 0 0110.64-1.23A4.5 4.5 0 1118 14H6Z" fill="currentColor"/>
              <path d="M7 20l2-3m3 3l2-3m3 3l2-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg> 雨
          </button>
          <button data-mode="snowy" aria-pressed="false" role="tab" aria-selected="false" title="下雪">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
              <path d="M12 2v20M4 6l16 12M20 6L4 18M6 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg> 雪
          </button>
          <button data-mode="windy" aria-pressed="false" role="tab" aria-selected="false" title="刮风">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" aria-hidden="true">
              <path d="M3 8h10a3 3 0 100-6 3 3 0 00-2.83 2M3 16h14a3 3 0 110 6 3 3 0 01-2.83-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg> 风
          </button>
        </div>

        <!-- 强度控制（三级） -->
        <div class="intensity" id="intensityCtl" role="tablist" aria-label="强度">
          <div class="seg-bg" id="intensityBg" aria-hidden="true"></div>
          <button class="active" data-intensity="low" aria-pressed="true" role="tab" aria-selected="true">低</button>
          <button data-intensity="med" aria-pressed="false" role="tab" aria-selected="false">中</button>
          <button data-intensity="high" aria-pressed="false" role="tab" aria-selected="false">高</button>
        </div>
      </div>

      <div class="body">
        <div class="left">
          <div class="temp" id="temp">26°</div>
          <div class="cond" id="condText">晴间少云 · 体感 27° · 空气优</div>

          <div class="trend">
            <div class="trend-title">
              <span>未来 6 小时</span>
              <span style="opacity:.8" id="trendRange">24° ~ 30°</span>
            </div>
            <canvas id="trendCanvas" width="600" height="140" aria-label="小时趋势"></canvas>
          </div>
        </div>

        <div class="right">
          <div class="meta">
            <div class="chip">风速<strong id="wind">3.0 m/s</strong></div>
            <div class="chip">湿度<strong id="humid">58%</strong></div>
            <div class="chip">气压<strong id="press">1012 hPa</strong></div>
          </div>
          <div class="meta">
            <div class="chip">日出<strong id="sunrise">05:48</strong></div>
            <div class="chip">日落<strong id="sunset">17:57</strong></div>
            <div class="chip aqi good" id="aqiChip">
              <div>AQI</div>
              <div class="aqi"><strong id="aqiNum">38</strong><span class="tag" id="aqiTag">优</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <span id="nowTime">--:--</span>
        <div class="bar"></div>
        <span id="desc">极光与散景随天气呼吸</span>
      </div>
    </div>
  </div>

  <script>
    // 工具
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
    const rand = (a,b)=>Math.random()*(b-a)+a;
    const rint = (a,b)=>Math.floor(rand(a,b+1));
    const lerp = (a,b,t)=>a+(b-a)*t;

    const body = document.body;
    const card = $("#card");
    const scene = $("#scene");
    const sun = $("#sun");
    const mist = $("#mist");
    const bokeh = $("#bokeh");
    const snowPile = $("#snowPile");
    const leafPile = $("#leafPile");
    const veil = $("#veil");
    const segBg = $("#segBg");
    const toggle = document.querySelector(".toggle");
    const canvas = $("#trendCanvas");
    const ctx = canvas.getContext("2d");

    // 强度控制
    const intensityCtl = $("#intensityCtl");
    const intensityBg = $("#intensityBg");

    const UI = {
      temp: $("#temp"), cond: $("#condText"),
      wind: $("#wind"), humid: $("#humid"), press: $("#press"),
      sunrise: $("#sunrise"), sunset: $("#sunset"),
      nowTime: $("#nowTime"), desc: $("#desc"),
      trendRange: $("#trendRange"),
      badge: $("#badge"),
      aqiNum: $("#aqiNum"), aqiTag: $("#aqiTag"), aqiChip: $("#aqiChip"),
    };

    // 移动端检测（降粒子/禁 3D）
    const isMobile = window.matchMedia("(max-width: 640px)").matches;

    // 按天气分配季节（用户要求：春夏秋冬）
    const SEASON_BY_WEATHER = {
      sunny: "夏季",
      rainy: "春季",
      snowy: "冬季",
      windy: "秋季"
    };

    // 强度标签与默认值
    const INTENSITY = {
      sunny: [
        {key:"low", label:"清爽"},
        {key:"med", label:"晴间"},
        {key:"high", label:"炎热"}
      ],
      rainy: [
        {key:"low", label:"小雨"},
        {key:"med", label:"中雨"},
        {key:"high", label:"暴雨"}
      ],
      snowy: [
        {key:"low", label:"小雪"},
        {key:"med", label:"中雪"},
        {key:"high", label:"暴雪"}
      ],
      windy: [
        {key:"low", label:"微风"},
        {key:"med", label:"大风"},
        {key:"high", label:"狂风"}
      ],
    };
    let intensityByMode = { sunny:"med", rainy:"med", snowy:"med", windy:"med" };
    let CURRENT_INT_FACTOR = 1; // 由强度计算出的倍数

    // 天气配置
    const WEATHER = {
      sunny:{ name:"晴间少云", temp:[27,33], wind:[1.2,3.6], humid:[35,55], press:[1008,1016], sunrise:"05:48", sunset:"17:57", desc:"金色柔光，云影轻掠", aqi:[20,60] },
      rainy:{ name:"阵雨",     temp:[19,25], wind:[2.4,5.8], humid:[72,92], press:[1004,1010], sunrise:"05:50", sunset:"17:55", desc:"蓝灰雨幕，光晕泛冷", aqi:[40,100] },
      snowy:{ name:"小雪",     temp:[-4,1],  wind:[0.8,2.8], humid:[66,86], press:[1015,1024], sunrise:"06:20", sunset:"17:20", desc:"轻雪无声，空气清冽", aqi:[18,55] },
      windy:{ name:"大风",     temp:[15,22], wind:[5.2,10.2], humid:[40,60], press:[1007,1013], sunrise:"05:56", sunset:"17:50", desc:"风起云涌，叶影翻飞", aqi:[30,80] }
    };
    let current = "sunny";
    let lightningTimer = null;

    // 雨角 & 漂移（由风速联动）
    let RAIN_ANGLE = 11;   // deg
    let RAIN_DRIFT = 38;   // px

    function getIntensityFactor(mode, key){
      // 基础倍数：低 0.6，中 1.0，高 1.6
      const base = key==="low" ? 0.6 : (key==="high" ? 1.6 : 1.0);
      // 细分校准：不同天气在“高”时稍有不同夸张度
      if (mode==="rainy" && key==="high") return 1.8;
      if (mode==="windy" && key==="high") return 1.7;
      if (mode==="snowy" && key==="high") return 1.7;
      return base;
    }

    // UI 更新（按天气分配季节）
    function updateUI(mode){
      const d = WEATHER[mode];
      const seasonName = SEASON_BY_WEATHER[mode] || "";

      let t = Math.round(rand(d.temp[0], d.temp[1]));
      t = clamp(t, -25, 46);
      const w = rand(d.wind[0], d.wind[1]).toFixed(1);
      const h = Math.round(rand(d.humid[0], d.humid[1]));
      const p = Math.round(rand(d.press[0], d.press[1]));
      const aqi = Math.round(rand(d.aqi[0], d.aqi[1]));
      const aqiState = aqi <= 50 ? "good" : "moderate";

      UI.temp.textContent = t + "°";
      const feels = clamp(t + (mode === "sunny" ? 1 : -1), -25, 46);
      UI.cond.textContent = `${d.name} · ${seasonName} · 体感 ${feels}° · 空气${aqiState === "good" ? "优" : "良"}`;

      // 根据风速联动雨角与水平漂移（仅影响雨天渲染参数）
      const windVal = parseFloat(w);
      RAIN_ANGLE = clamp(6 + windVal * 2.2, 8, 20);
      RAIN_DRIFT = clamp(26 + windVal * 6, 28, 72);

      UI.wind.textContent = `${w} m/s`;
      UI.humid.textContent = `${h}%`;
      UI.press.textContent = `${p} hPa`;
      // 使用各天气预设的日出/日落
      UI.sunrise.textContent = d.sunrise;
      UI.sunset.textContent = d.sunset;
      UI.desc.textContent = d.desc;

      UI.aqiNum.textContent = aqi;
      UI.aqiTag.textContent = aqiState === "good" ? "优" : "良";
      UI.aqiChip.classList.toggle("good", aqiState === "good");
      UI.aqiChip.classList.toggle("moderate", aqiState === "moderate");

      // 趋势线模拟数据（6小时）
      const tmin = d.temp[0];
      const tmax = d.temp[1];
      const data = Array.from({length:7}, (_,i)=>{
        return Math.round(lerp(tmin, tmax, 0.4+0.2*Math.sin(i/6*Math.PI)) + rand(-1.2,1.2));
      });
      UI.trendRange.textContent = `${Math.min(...data)}° ~ ${Math.max(...data)}°`;
      drawTrend(data);
    }

    // 趋势火花线
    function drawTrend(series){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const W = canvas.clientWidth * dpr;
      const H = canvas.clientHeight * dpr;
      if (canvas.width !== W) canvas.width = W;
      if (canvas.height !== H) canvas.height = H;
      ctx.clearRect(0,0,W,H);

      const pad = 18*dpr;
      const x0 = pad, x1 = W-pad;
      const y0 = pad, y1 = H-pad;
      const n = series.length;
      const min = Math.min(...series), max = Math.max(...series);

      // 背景网格
      ctx.strokeStyle = "rgba(255,255,255,0.08)";
      ctx.lineWidth = 1*dpr;
      ctx.beginPath();
      for(let i=0;i<4;i++){
        const y = y0 + (i/3)*(y1-y0);
        ctx.moveTo(x0, y); ctx.lineTo(x1, y);
      }
      ctx.stroke();

      // 曲线与阴影
      const accent = getComputedStyle(document.body).getPropertyValue('--accent').trim();
      const grd = ctx.createLinearGradient(x0, y0, x0, y1);
      grd.addColorStop(0, hexToRgba(accent, 0.66));
      grd.addColorStop(1, hexToRgba(accent, 0.14));

      // 填充
      ctx.beginPath();
      for(let i=0;i<n;i++){
        const x = x0 + (i/(n-1))*(x1-x0);
        const y = y1 - ((series[i]-min)/(max-min||1))*(y1-y0);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
 
      ctx.lineTo(x1,y1); ctx.lineTo(x0,y1); ctx.closePath();
      ctx.fillStyle = grd; ctx.fill();
 
      // 高光主线
      ctx.beginPath();
      for(let i=0;i<n;i++){
        const x = x0 + (i/(n-1))*(x1-x0);
        const y = y1 - ((series[i]-min)/(max-min||1))*(y1-y0);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.lineWidth = 2.2*dpr;
      ctx.strokeStyle = hexToRgba(accent, 0.9);
      ctx.shadowColor = hexToRgba(accent, 0.4);
      ctx.shadowBlur = 14*dpr;
      ctx.stroke();
 
      // 节点
      ctx.shadowBlur = 0;
      for(let i=0;i<n;i++){
        const x = x0 + (i/(n-1))*(x1-x0);
        const y = y1 - ((series[i]-min)/(max-min||1))*(y1-y0);
        ctx.beginPath();
        ctx.arc(x, y, 2.8*dpr, 0, Math.PI*2);
        ctx.fillStyle = "#fff";
        ctx.fill();
      }
    }
 
    // 强度 UI 构建与同步（全局）
    function buildIntensityUI(mode){
      if (!intensityCtl) return;
      const defs = INTENSITY[mode] || INTENSITY.sunny;
      const btns = intensityCtl.querySelectorAll("button");
      btns.forEach((b,i)=>{
        const d = defs[i];
        if (d){
          b.textContent = d.label;
          b.dataset.intensity = d.key;
        }
      });
      const curr = intensityByMode[mode] || "med";
      const idx = ["low","med","high"].indexOf(curr);
      moveIntensityBg(idx);
      btns.forEach((b,i)=>{
        const on = i===idx;
        b.classList.toggle("active", on);
        b.setAttribute("aria-pressed", String(on));
        b.setAttribute("aria-selected", String(on));
      });
      // 计算当前倍数
      CURRENT_INT_FACTOR = getIntensityFactor(mode, curr);
    }
 
    function moveIntensityBg(idx){
      if (!intensityCtl || !intensityBg) return;
      const btns = intensityCtl.querySelectorAll("button");
      const btn = btns[idx] || btns[0];
      const left = btn.offsetLeft;
      const w = btn.offsetWidth;
      intensityBg.style.left = left + "px";
      intensityBg.style.width = w + "px";
    }

    function hexToRgba(hex, a){
      const h = hex.replace('#','').trim();
      const r = parseInt(h.substring(0,2),16);
      const g = parseInt(h.substring(2,4),16);
      const b = parseInt(h.substring(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    }

    // 粒子清理（并重置仅雪天可见的元素）
    function clearFX(){
      [...scene.querySelectorAll(".raindrop,.flake,.wind-line,.leaf,.cloud,.splash,.splash-dot,.lightning,.swirl,.snow-cap,.leaf-cap")].forEach(n=>n.remove());
      bokeh.innerHTML = "";
      // 非雪天应隐藏的持久层
      if (snowPile) snowPile.style.height = "0px";
      if (leafPile) leafPile.style.height = "0px";
      if (mist) mist.style.opacity = "0";
    }

    // 云
    function makeCloud(x,y,scale,opacity,duration){
      const c = document.createElement("div");
      c.className = "cloud";
      c.style.width = (100*scale)+"px";
      c.style.height = (42*scale)+"px";
      c.style.left = x+"px";
      c.style.top = y+"px";
      c.style.opacity = opacity;
      c.animate([{transform:"translateX(-22%)"}, {transform:"translateX(126%)"}], {duration, iterations:Infinity, easing:"linear", delay: rand(0,duration)});
      scene.appendChild(c);
    }

    // 散景
    function spawnBokeh(count, speedBase=9000, size=10){
      const w = card.clientWidth;
      const h = card.clientHeight;
      const k = isMobile ? 0.6 : 1;
      for(let i=0;i<Math.round(count*k);i++){
        const dot = document.createElement("div");
        dot.className = "dot";
        const s = rand(size*0.6, size*1.6);
        dot.style.width = s+"px";
        dot.style.height = s+"px";
        dot.style.left = rand(-w*0.1, w*0.9) + "px";
        dot.style.top = rand(-h*0.2, h*0.1) + "px";
        dot.style.animationDuration = rint(speedBase*0.7, speedBase*1.4) + "ms";
        dot.style.animationDelay = rint(-speedBase, 0) + "ms";
        bokeh.appendChild(dot);
      }
    }

    // 雨溅波纹
    function spawnSplash(x, y){
      const s = document.createElement("div");
      s.className = "splash";
      s.style.left = x + "px";
      s.style.top = y + "px";
      scene.appendChild(s);
      setTimeout(()=> s.remove(), 900);
    }

    // 闪电
    function scheduleLightning(){
      if (lightningTimer) clearTimeout(lightningTimer);
      const next = rint(4000, 9000);
      lightningTimer = setTimeout(()=>{
        if (current !== "rainy") return;
        const l = document.createElement("div");
        l.className = "lightning";
        scene.appendChild(l);
        setTimeout(()=> l.remove(), 620);
        scheduleLightning();
      }, next);
    }

    // 雨/雪/风粒子
    function spawnRain(){
      const w = card.clientWidth, h = card.clientHeight;
      const base = Math.round((w*h)/4200 * CURRENT_INT_FACTOR);
      const mid = isMobile ? Math.round(base*0.65) : Math.round(base);   // 中景（当前层）
      const near = Math.round(mid * (0.35 * CURRENT_INT_FACTOR));       // 前景
      const far  = Math.round(mid * (0.60 / CURRENT_INT_FACTOR));       // 远景

      // 分层批量注入，减少回流
      const fragFar  = document.createDocumentFragment();
      const fragMid  = document.createDocumentFragment();
      const fragNear = document.createDocumentFragment();

      // 工具：创建一滴雨
      function makeDrop(layer, heightMin, heightMax, durMin, durMax, opMin, opMax, driftMul, angle){
        const d = document.createElement("div");
        d.className = "raindrop";
        const rx = rand(-30, w+30);
        const ry = rand(-180, -20);
        d.style.left = rx + "px";
        d.style.top = ry + "px";
        const hh = rand(heightMin, heightMax);
        d.style.height = hh + "px";
        const dur = rint(durMin, durMax);
        d.style.animationDuration = dur + "ms";
        d.style.animationDelay = rint(-dur, 0) + "ms";
        d.style.opacity = rand(opMin, opMax).toFixed(2);
        // 每滴的风向与水平漂移（由风速联动值派生）
        const drift = Math.round(RAIN_DRIFT * driftMul);
        d.style.setProperty("--drift", drift + "px");
        d.style.setProperty("--angle", (angle ?? RAIN_ANGLE) + "deg");
        // 偶发底部溅射与子滴
        d.addEventListener("animationiteration", ()=>{
          const by = h - 24 + rand(-6, 6);
          if (Math.random() < 0.18){
            spawnSplash(clamp(parseFloat(d.style.left||0)+drift, 8, w-20), by);
            // 子滴 2~3 个
            const n = isMobile ? 2 : rint(2,3);
            for (let i=0;i<n;i++){
              const sd = document.createElement("div");
              sd.className = "splash-dot";
              sd.style.left = (clamp(parseFloat(d.style.left||0)+drift, 8, w-20)) + "px";
              sd.style.top = by + "px";
              // 抛物向量
              const dx = (i===0? rand(-18, -8) : rand(8, 18));
              const dy = rand(-44, -32);
              sd.style.setProperty("--dx", dx+"px");
              sd.style.setProperty("--dy", dy+"px");
              scene.appendChild(sd);
              setTimeout(()=> sd.remove(), 700);
            }
          }
        });
        layer.appendChild(d);
      }

      // 远景：更细、更慢、更暗
      for(let i=0;i<far;i++){
        makeDrop(fragFar, 10, 16, 1400, 2000, 0.35, 0.6, 0.6, RAIN_ANGLE - 2);
      }
      // 中景：基准
      for(let i=0;i<mid;i++){
        makeDrop(fragMid, 12, 22, 1100, 1750, 0.6, 0.85, 1.0, RAIN_ANGLE);
      }
      // 前景：更粗、更快、更亮
      for(let i=0;i<near;i++){
        makeDrop(fragNear, 16, 28, 900, 1400, 0.75, 0.95, 1.2, RAIN_ANGLE + 2);
      }

      scene.appendChild(fragFar);
      scene.appendChild(fragMid);
      scene.appendChild(fragNear);

      // 云层
      for(let i=0;i<2;i++){
        makeCloud(rand(-16,12), rand(26,66), rand(1.3,1.7), .26, rint(24000,32000));
      }
      // 冷色散景
      spawnBokeh(10, 10000, 10);

      // 明确关闭雪/叶相关持久层
      growSnowPile(false);
      growLeafPile(false);
      if (mist) mist.style.opacity = "0";

      // 闪电事件
      scheduleLightning();
    }

    function spawnSnow(){
      const w = card.clientWidth, h = card.clientHeight;
      const base = Math.round((w*h)/8600 * CURRENT_INT_FACTOR);
      const flakes = isMobile ? Math.round(base*0.7) : Math.round(base);
      for(let i=0;i<flakes;i++){
        const f = document.createElement("div");
        f.className = "flake";
        const size = rand(4,10);
        f.style.width = size + "px";
        f.style.height = size + "px";
        f.style.left = rand(-20, w-10) + "px";
        f.style.top = rand(-180, -20) + "px";
        f.style.animationDuration = rint(5400, 9400) + "ms";
        f.style.animationDelay = rint(-4400, 0) + "ms";
        // 偶发在底部生成小堆
        f.addEventListener("animationiteration", ()=>{
          if (Math.random() < 0.18) createSnowCap();
        });
        scene.appendChild(f);
      }
      for(let i=0;i<2;i++){
        makeCloud(rand(-28,4), rand(30,88), rand(1.15,1.5), .22, rint(30000,42000));
      }
      spawnBokeh(14, 12000, 12); // 冷白散景
      mist.style.opacity = ".16";
      growSnowPile(true);
    }

    function spawnWind(){
      const w = card.clientWidth, h = card.clientHeight;
      const lineBase = Math.round(24 * CURRENT_INT_FACTOR);
      const lines = isMobile ? Math.round(lineBase*0.7) : lineBase;
      for(let i=0;i<lines;i++){
        const wl = document.createElement("div");
        wl.className = "wind-line";
        wl.style.top = rand(12, h-24) + "px";
        wl.style.left = rand(-140, -20) + "px";
        wl.style.animationDuration = rint(2500, 4100) + "ms";
        wl.style.animationDelay = rint(-3400, 0) + "ms";
        scene.appendChild(wl);
      }
      const leavesBase = Math.round(16 * CURRENT_INT_FACTOR);
      const leaves = isMobile ? Math.round(leavesBase*0.7) : leavesBase;
      for(let i=0;i<leaves;i++){
        const leaf = document.createElement("div");
        leaf.className = "leaf";
        leaf.style.left = rand(-36, 38) + "px";
        leaf.style.top = rand(-36, 96) + "px";
        leaf.style.animationDuration = rint(3400, 6000) + "ms";
        leaf.style.animationDelay = rint(-2800, 0) + "ms";
        leaf.style.transform = `translate(${rint(-60, 24)}px, ${rint(-30, 32)}px) rotate(${rint(0,360)}deg)`;
        scene.appendChild(leaf);
      }
      // 涡旋
      const swirlCount = isMobile ? 1 : 2;
      for(let i=0;i<swirlCount;i++){
        const s = document.createElement("div");
        s.className = "swirl";
        s.style.left = rand(-80, 20) + "px";
        s.style.top = rand(10, h*0.6) + "px";
        s.style.animationDelay = rint(-1600, 0) + "ms";
        scene.appendChild(s);
      }
      for(let i=0;i<2;i++){
        makeCloud(rand(-36, 10), rand(22, 58), rand(1.15, 1.45), .2, rint(16000, 22000));
      }
      spawnBokeh(8, 9000, 10); // 青绿散景
      // 明确关闭雪相关持久层
      growSnowPile(false);
      if (mist) mist.style.opacity = "0";
    }

    function spawnSunny(){
      // 仅晴天显示太阳
      if (sun) sun.style.display = "block";
      mist.style.opacity = "0";

      // 根据强度调整“晴”的视觉与元素
      const level = intensityByMode.sunny || "med";
      const isHot = level === "high";

      // 热浪主题：更亮的强调色与更清透的天空，且无云
      if (isHot) {
        document.body.style.setProperty('--accent', '#FFE27A');
        document.body.style.setProperty('--accent-2', '#FFC86A');
        document.body.style.setProperty('--sky-a', '#0A1230');
        document.body.style.setProperty('--sky-b', '#1F4596');
      } else {
        // 恢复为主题默认（移除覆盖）
        document.body.style.removeProperty('--accent');
        document.body.style.removeProperty('--accent-2');
        document.body.style.removeProperty('--sky-a');
        document.body.style.removeProperty('--sky-b');
      }

      // 太阳强调态
      if (sun) {
        sun.classList.toggle('hot', isHot);
      }

      // 云量：高强度（炎热）无云，其余随强度
      const clouds = isHot ? 0 : Math.max(1, Math.round(2 * CURRENT_INT_FACTOR));
      for(let i=0;i<clouds;i++){
        makeCloud(rand(-24,92), rand(34,112), rand(1.1,1.6), rand(.18,.3), rint(28000,42000));
      }

      // 散景：高强度更明亮更密集
      const bokehCount = Math.round((isHot ? 16 : 12) * CURRENT_INT_FACTOR);
      spawnBokeh(bokehCount, 10000, 12);

      // 清理雪堆（晴无雪）
      growSnowPile(false);
      // 叶堆不在晴天显示
      if (typeof growLeafPile === 'function') growLeafPile(false);
    }

    // 切换天气（加入轻遮罩过渡，体验更顺滑）
    function setWeather(mode){
      current = mode;

      // 轻遮罩淡入，缓解切换顿挫
      veil.classList.add("show");

      body.classList.remove("theme--sunny","theme--rainy","theme--snowy","theme--windy");
      body.classList.add(`theme--${mode}`);
      card.classList.remove("is-sunny","is-rainy","is-snowy","is-windy");
      card.classList.add(`is-${mode}`);

      // 明确控制太阳显隐，防止“下雨还见太阳”的视觉问题
      if (sun) sun.style.display = (mode === "sunny") ? "block" : "none";

      // 切到晴天时给太阳一个明显的“闪耀”过渡
      if (mode === "sunny" && sun) {
        sun.animate(
          [
            { transform: 'scale(.82)', opacity: .0, filter: 'brightness(1.2)' },
            { transform: 'scale(1.08)', opacity: 1, filter: 'brightness(1.35)' },
            { transform: 'scale(1.00)', opacity: 1, filter: 'brightness(1.0)' }
          ],
          { duration: 520, easing: 'cubic-bezier(.2,.8,.2,1)' }
        );
      }

      clearFX();
      if (lightningTimer) { clearTimeout(lightningTimer); lightningTimer = null; }

      updateUI(mode);
      // 同步强度 UI 与倍数
      buildIntensityUI(mode);

      if(mode==="sunny") spawnSunny();
      if(mode==="rainy") spawnRain();
      if(mode==="snowy") { if (sun) sun.style.display = "none"; spawnSnow(); }
      if(mode==="windy") spawnWind();

      const idx = ["sunny","rainy","snowy","windy"].indexOf(mode);
      moveSegBg(idx); // 精准对齐选中分段

      $$(".toggle button").forEach((btn,i)=>{
        const on = i===idx;
        btn.classList.toggle("active", on);
        btn.setAttribute("aria-pressed", String(on));
        btn.setAttribute("aria-selected", String(on));
      });

      UI.badge.animate(
        [{ boxShadow: "0 0 0 0 color-mix(in srgb, var(--accent) 52%, transparent)" },
         { boxShadow: "0 0 0 14px rgba(0,0,0,0)" }],
        { duration: 620, easing:"ease-out" }
      );

      // 遮罩淡出
      setTimeout(()=> veil.classList.remove("show"), 220);
    }

    // 分段选中背景定位（避免 transform 误差）
    function moveSegBg(idx){
      const btns = $$(".toggle button");
      const btn = btns[idx] || btns[0];
      // segBg 绝对定位的基准是 .toggle 的内边缘（padding edge）
      // offsetLeft 同样是相对于 padding edge，因此无需额外加 padding
      const left = btn.offsetLeft;
      const w = btn.offsetWidth;
      segBg.style.left = left + "px";
      segBg.style.width = w + "px";
    }

    // 3D 倾斜/环境光跟随（移动端禁用倾斜）
    (function bind3D(){
      if (isMobile) return;
      let rx=0, ry=0, tx=0, ty=0;
      let raf;
      function onMove(e){
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left) / r.width;
        const y = (e.clientY - r.top) / r.height;
        tx = (x - 0.5) * 10; // rotateY
        ty = (0.5 - y) * 8;  // rotateX
        const mx = clamp(x*100, 0, 100);
        const my = clamp(y*100, 0, 100);
        card.style.setProperty("--mx", mx+"%");
        card.style.setProperty("--my", my+"%");
        if(!raf) loop();
      }
      function loop(){
        rx = lerp(rx, ty, 0.12);
        ry = lerp(ry, tx, 0.12);
        card.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
        raf = Math.abs(rx-ty) < 0.01 && Math.abs(ry-tx) < 0.01 ? null : requestAnimationFrame(loop);
      }
      card.addEventListener("mousemove", onMove);
      card.addEventListener("mouseleave", ()=>{ tx=0; ty=0; if(!raf) loop(); });
    })();

    // 雪堆控制
    function growSnowPile(on){
      if (!snowPile) return;
      snowPile.style.height = on ? (isMobile ? "18px" : "26px") : "0px";
    }
    function createSnowCap(){
      if (!snowPile) return;
      // 控制最大数量，避免堆积过多
      const maxCaps = 40;
      const caps = scene.querySelectorAll(".snow-cap");
      if (caps.length > maxCaps) caps[0].remove();
      const w = card.clientWidth;
      const cap = document.createElement("div");
      cap.className = "snow-cap";
      const cw = rint(8,16);
      cap.style.width = cw + "px";
      cap.style.left = clamp(rint(4, w-20), 4, w-20) + "px";
      scene.appendChild(cap);
      // 自然消退以免无限增长
      setTimeout(()=>{ cap.style.opacity = ".85"; }, 1200);
    }

    // 落叶堆控制
    function growLeafPile(on){
      if (!leafPile) return;
      leafPile.style.height = on ? (isMobile ? "14px" : "22px") : "0px";
    }
    function createLeafCap(){
      if (!leafPile) return;
      const maxCaps = 48;
      const caps = scene.querySelectorAll(".leaf-cap");
      if (caps.length > maxCaps) caps[0].remove();
      const w = card.clientWidth;
      const cap = document.createElement("div");
      cap.className = "leaf-cap";
      const cw = rint(8,14);
      cap.style.width = cw + "px";
      cap.style.left = clamp(rint(4, w-20), 4, w-20) + "px";
      scene.appendChild(cap);
      setTimeout(()=>{ cap.style.opacity = ".9"; }, 1200);
    }

    // 时间
    function tick(){
      const now = new Date();
      UI.nowTime.textContent = `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
    }

    // 交互
    toggle.addEventListener("click", e=>{
      const btn = e.target.closest("button[data-mode]"); if(!btn) return;
      const idx = ["sunny","rainy","snowy","windy"].indexOf(btn.dataset.mode);
      setWeather(btn.dataset.mode);
      moveSegBg(idx);
    });
    toggle.addEventListener("keydown", e=>{
      const modes = ["sunny","rainy","snowy","windy"];
      let idx = modes.indexOf(current);
      if(e.key==="ArrowRight"){ idx=(idx+1)%modes.length; setWeather(modes[idx]); moveSegBg(idx); }
      if(e.key==="ArrowLeft"){ idx=(idx-1+modes.length)%modes.length; setWeather(modes[idx]); moveSegBg(idx); }
    });
 
    // 强度交互
    if (intensityCtl){
      intensityCtl.addEventListener("click", e=>{
        const btn = e.target.closest("button[data-intensity]"); if(!btn) return;
        const list = ["low","med","high"];
        const idx = list.indexOf(btn.dataset.intensity);
        intensityByMode[current] = btn.dataset.intensity;
        CURRENT_INT_FACTOR = getIntensityFactor(current, btn.dataset.intensity);
        // 更新 UI 状态
        const btns = intensityCtl.querySelectorAll("button");
        btns.forEach((b,i)=>{
          const on = i===idx;
          b.classList.toggle("active", on);
          b.setAttribute("aria-pressed", String(on));
          b.setAttribute("aria-selected", String(on));
        });
        moveIntensityBg(idx);
        // 重新渲染当前天气强度
        const m = current;
        clearFX();
        if(m==="sunny") spawnSunny();
        if(m==="rainy") spawnRain();
        if(m==="snowy") { if (sun) sun.style.display = "none"; spawnSnow(); }
        if(m==="windy") spawnWind();
      });
    }

    // 初始化
    setWeather("sunny");
    moveSegBg(0);
    // 初始化强度条
    buildIntensityUI("sunny");
    tick();
    setInterval(tick, 30*1000);

    // Resize：重生粒子 + 重绘趋势
    let rs;
    window.addEventListener("resize", ()=>{
      clearTimeout(rs);
      rs = setTimeout(()=>{
        const m = current;
        clearFX();
        if(m==="sunny") spawnSunny();
        if(m==="rainy") spawnRain();
        if(m==="snowy") spawnSnow();
        if(m==="windy") spawnWind();
        updateUI(m);
        // 重新定位分段背景
        const idx = ["sunny","rainy","snowy","windy"].indexOf(m);
        moveSegBg(idx);
      }, 160);
    });

    // 入场
    card.animate(
      [{ transform:"translateZ(0) translateY(16px) scale(.985)", opacity:0 }, { transform:"translateZ(0) translateY(0) scale(1)", opacity:1 }],
      { duration: 600, easing:"cubic-bezier(.2,.8,.2,1)" }
    );
  </script>
</body>
</html>